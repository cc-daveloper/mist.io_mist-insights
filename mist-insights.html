<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<script src="../moment/moment.js"></script>
<!--
`mist-insights`


@demo demo/index.html
-->

<dom-module id="mist-insights">
    <template>
        <style>
             :host {
                display: block;
            }

            #graphRow[largescreen] {
                display: flex;
            }

            #graphRow[largescreen] .block+.block {
                padding-left: 48px;
            }
        </style>

        <iron-media-query query="(min-width: 1180px)" query-matches="{{largescreen}}"></iron-media-query>

        <paper-material id="filtering" class="margin-botttom">
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <div class="smaller">Time</div>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="window" class="dropdown-content" attr-for-selected="value" selected="{{timeParams.window}}">
                            <paper-item value="hour">hourly</paper-item>
                            <paper-item value="day">daily</paper-item>
                            <paper-item value="week">weekly</paper-item>
                            <paper-item value="month">monthly</paper-item>
                            <paper-item value="quarter">quarterly</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="past" class="dropdown-content" attr-for-selected="value" selected="{{timeParams.past}}">
                            <template is="dom-repeat" items="{{pastItems}}" as="past">
                                <paper-item value="[[past.value]]">[[past.text]]</paper-item>
                            </template>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
                <div class="flexchild">
                    <div class="smaller">Filter by</div>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="filterbyType" class="dropdown-content" attr-for-selected="value" selected="{{filterby.type}}">
                            <paper-item value="stack">Stack</paper-item>
                            <paper-item value="cloud">Cloud</paper-item>
                            <paper-item value="tag">Tag</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu id="filterbyNameDd" class="uppercase" no-label-float>
                        <paper-menu id="filterbyName" class="dropdown-content" attr-for-selected="value" selected="{{filterby.id}}">
                            <template is="dom-repeat" items="{{clouds}}">
                                <paper-item value="[[item.id]]" data-name$="[[item.name]][[item.title]]">[[item.name]][[item.title]]</paper-item>
                            </template>
                            <paper-item disabled hidden$="{{!filterbyDisable}}">
                                <span hidden$="{{!filterby.type}}">no {{filterby.type}}s</span>
                                <span hidden$="{{filterby.type.length}}">Select type</span>
                            </paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-button class="inline baseline smaller" on-tap="clearFilter" disabled$="{{!filterby.id.length}}">clear</paper-button>
                </div>
            </div>
        </paper-material>

        <!-- <h2>[[clouds]]!</h2> -->

        <h2>Cost per month</h2>
        <div id="costgraph" style="width:100%; min-height:300px;"></div>

        <h2>Load</h2>
        <div id="loadgraph" style="width:100%; min-height:300px;"></div>

        <h2>Machines Count</h2>
        <div id="machinesgraph" style="width:100%; min-height:300px;"></div>



        <iron-ajax id="cloudsAjax"
            method="GET"
            url$="[[uri]]/api/v1/clouds"
            headers$='{"Authorization": "[[token]]"}'
            handle-as="json"
            loading={{loading}}
            on-response="handleResponseClouds"
            on-error="handleError"></iron-ajax>

        <iron-ajax id="reportAjax"
            method="GET"
            url$="[[uri]]/api/v1/report"
            headers$='{"Authorization": "[[token]]"}'
            handle-as="json"
            loading="{{loadingData}}"
            on-response="handleResponseReport"
            on-error="handleError"
            params=[[params]]></iron-ajax>

        <iron-ajax id="loadReportAjax"
            method="GET"
            url="[[uri]]/api/v1/report?type=load"
            headers$='{"Authorization": "[[token]]"}'
            handle-as="json"
            loading="{{loadingDataLoad}}"
            on-response="handleResponseLoad"
            on-error="handleError"
            params=[[params]]></iron-ajax>

    </template>

    <script>
    Polymer({
        is: 'mist-insights',

        properties: {
            model: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            token: {
                type: String,
                value: '',
            },
            uri: {
                type: String,
                value: 'https://mist.io'
            },
            largescreen: Boolean,
            params: {
                type: Object
            },
            timeParams: {
                type: Object,
                value: {
                    window: "day",
                    past: "0"
                }
            },
            filterby: {
                type: Object,
                value: function () {
                    return {
                        type: '',
                        name: '',
                        id: ''
                    };
                }
            },
            clouds: Array,
            stacks: Array,
            report: Object,
            reportLoad: Object,
            costgraph: Object,
            costgraphOptions: {
                    type: Object,
                    value: function () {
                        return {
                            tooltip : {
                                trigger: 'axis',
                                formatter: "{b}: <br/>${c}",
                                axisPointer: {
                                    type: 'cross',
                                    label: {
                                        backgroundColor: '#6a7985'
                                    }
                                }
                            },
                            legend: {
                                data:['Cost per month']
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis : [
                                {
                                    type : 'category',
                                    boundaryGap : false,
                                    data : []
                                }
                            ],
                            yAxis : [
                                {
                                    type : 'value'
                                }
                            ],
                            series : [
                                {
                                    name:'Cost',
                                    type:'line',
                                    stack: 'f',
                                    areaStyle: {normal: {color: "rgba(0,155,155,0.2)"}},
                                    lineStyle: {normal: {color: "rgba(0,155,155,1)"}},
                                    itemStyle: {normal: {borderColor: "rgba(0,155,155,1)"}},
                                    data:[]
                                }
                            ]
                        }
                    }
                },
            loadgraph: Object,
            loadgraphOptions: {
                    type: Object,
                    value: function () {
                        return {
                            tooltip : {
                                trigger: 'axis',
                                axisPointer: {
                                    type: 'cross',
                                    label: {
                                        backgroundColor: '#6a7985'
                                    }
                                }
                            },
                            legend: {
                                data:[{
                                    name:'Load',
                                    textStyle: "rgba(0,155,155,1)",
                                },{
                                    name:'Cores',
                                    textStyle: "rgba(250,128,114,1)",
                                }]
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis : [
                                {
                                    type : 'category',
                                    boundaryGap : false,
                                    data : ['1','2','3','4']
                                }
                            ],
                            yAxis : [
                                {
                                    type : 'value'
                                }
                            ],
                            series : [
                                {
                                    name:'Cores',
                                    type:'line',
                                    stack: 'f',
                                    areaStyle: {normal: {color: "rgba(0,155,155,0.2)"}},
                                    lineStyle: {normal: {color: "rgba(0,155,155,1)"}},
                                    itemStyle: {normal: {borderColor: "rgba(0,155,155,1)"}},
                                    data:[120, 132, 101, 134]
                                },
                                {
                                    name:'Load',
                                    type:'line',
                                    stack: 'g',
                                    areaStyle: {normal: {color: "rgba(250,128,114,0.2)"}},
                                    lineStyle: {normal: {color: "rgba(250,128,114,1)"}},
                                    itemStyle: {normal: {borderColor: "rgba(250,128,114,1)"}},
                                    data:[120, 132, 101, 134]
                                }
                            ]
                        }
                    }
                },
            machinesgraph: Object,
            machinesgraphOptions: {
                type: Object,
                value: {
                    color: ["rgba(0,155,155,0.2)"],
                    borderColor: ["rgba(0,155,155,1)"],
                    tooltip : {
                        trigger: 'axis',
                        axisPointer : {
                            type : 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis : [
                        {
                            type : 'category',
                            data : ['Mon'],
                            axisTick: {
                                alignWithLabel: true
                            }
                        }
                    ],
                    yAxis : [
                        {
                            type : 'value'
                        }
                    ],
                    series : [
                        {
                            name:'machines',
                            type:'bar',
                            barWidth: '60%',
                            data:[10]
                        }
                    ]
                }
            }
        },

        observers: [
            'updateData(report.history)',
            'updateLoadData(reportLoad.history)',
        ],

        attached: function () {
            if (typeof echarts == 'undefined')
                this.importHref(this.resolveUrl('echarts-import.html'), this.initCharts, function(e) {
                    console.error('Failed to load echarts', e);
                }, true);
            else
                this.initCharts();

            if (!this.token)
                this.uri = '';
            this.$.cloudsAjax.generateRequest();
            this.$.reportAjax.generateRequest();
            this.$.loadReportAjax.generateRequest();
        },

        initCharts: function() {
            var colorPalette = ['#607D8B', '#d96557', '#3F51B5', '#009688', '#795548', '#8c76d1', '#795548', '#0277BD', '#0099cc', '#424242', '#D48900', '#43A047', '#2F2F3E'];
            echarts.registerTheme('insights', {
                color: colorPalette,
                backgroundColor: 'transparent',
                graph: {
                    color: colorPalette
                }
            });
            this.costgraph = echarts.init(this.$.costgraph, 'insights');
            this.machinesgraph = echarts.init(this.$.machinesgraph, 'insights');
            this.loadgraph = echarts.init(this.$.loadgraph, 'insights');
            /*this.drillcostgraph = echarts.init(this.$.drillcostgraph);
            this.updateChartWidth(e);*/
            console.log('initialized charts');
        },

        updateData: function (history) {
            var costData = [],
                machinesData = [],
                labels = [];
            if (history){
                labels = history.map(function(datapoint){
                    if (['day', 'hour'].indexOf(this.timeParams.window) != -1)
                        return moment(datapoint.date).format('HH:mm').toString();
                    else 
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                }, this);
                costData = history.map(function(datapoint){
                    return datapoint.cost_per_month;
                });
                machinesData = history.map(function(datapoint){
                    return datapoint.machine_count;
                });
            }

            this.set('costgraphOptions.xAxis.0.data', labels);
            this.set('costgraphOptions.series.0.data', costData);
            if (this.costgraph)
                this.costgraph.setOption(this.costgraphOptions);

            this.set('machinesgraphOptions.xAxis.0.data', labels);
            this.set('machinesgraphOptions.series.0.data', machinesData);
            if (this.machinesgraph)
                this.machinesgraph.setOption(this.machinesgraphOptions);
        },

        updateLoadData: function (history) {
            var loadData = [],
                coresData = [],
                labels = [];
            if (history){
                labels = history.map(function(datapoint){
                    if (['day', 'hour'].indexOf(this.timeParams.window) != -1)
                        return moment(datapoint.date).format('HH:mm').toString();
                    else 
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                }, this);
                loadData = history.map(function(datapoint){
                    return datapoint.load;
                });
                coresData = history.map(function(datapoint){
                    return datapoint.cores;
                });
            }

            this.set('loadgraphOptions.xAxis.0.data', labels);
            this.set('loadgraphOptions.series.0.data', coresData);
            this.set('loadgraphOptions.series.1.data', loadData);
            if (this.loadgraph)
                this.loadgraph.setOption(this.loadgraphOptions);
        },

        handleResponse: function (e) {
            console.log('handleResponse', e);
        },

        handleResponseClouds: function(e){
            console.log('handleResponseClouds', e);
            this.set('clouds', e.detail.xhr.response);
        },

        handleResponseReport: function(e){
            console.log('handleResponseReport', e);
            this.set('report', e.detail.xhr.response);
        },

        handleResponseLoad: function(e){
            console.log('handleResponseLoad', e);
            this.set('reportLoad', e.detail.xhr.response);
        },

        handleError: function (e) {
            console.log('handleError', e);
        }
    });
  </script>
</dom-module>