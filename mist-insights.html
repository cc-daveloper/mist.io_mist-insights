<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<script src="../moment/moment.js"></script>
<!--
`mist-insights`
usage example:
    <mist-insights  period="month"
                    stack-term="deployment"
                    cloud="cloud_id"
                    uri="http://localhost"
                    token="token_string"></mist-insights>

period: month, day, week, quarter
filter: cloud="cloud_id"
        stack="stack_id"
        tag="tag"
stack-term="deployment"

@demo demo/index.html
-->

<dom-module id="mist-insights">
    <template>
        <style include="default-theme iron-flex iron-flex-alignment iron-flex-factors">
            :host {
                display: block;
                font-family: 'Roboto', 'Noto', sans-serif;
                font-size: 16px;
                line-height: 1.8em;
                color: rgba(0,0,0,0.87);
            }

            h2 {
                font-size: 2.4em;
                margin: 0 !important;
                font-weight: 400;
                letter-spacing: 0;
                line-height: 48px;
            }

            h2.title {
                font-size: 1.6em;
                margin: 0 !important;
            }

            *[hidden] {
                display: none;
            }

            #graphRow[largescreen] {
                display: flex;
            }

            #graphRow[largescreen] .block+.block {
                padding-left: 48px;
            }

            .graph {
                width:100%;
                min-height:300px;
                margin-bottom: 40px;
            }

            .smaller {
                text-transform: uppercase;
                font-size: 0.9em;
                color: rgba(0,0,0,0.54)
            }

            .uppercase,
            paper-dropdown-menu.uppercase paper-item,
            paper-dropdown-menu.uppercase ::content #input {
                text-transform: uppercase;
            }

            paper-material {
                position: relative;
                display: block;
                padding: 24px;
                margin-bottom: 16px;
            }

            paper-spinner {
                margin: 10% calc(50% - 40px);
                width: 80px !important;
                height: 80px !important;
            }

            .red, .above {
                color: var(--red-color);
            }

            .green, .below {
                color: var(--green-color);
            }

            .sup {
                vertical-align: super;
                font-size: 0.55em;
                opacity: 0.34;
            }

            .opaque {
                opacity: 0.34
            }

            .filterby {
                display: inline-block;
            }

            .highlight {
                background-color: #ffff8d;
                padding: 2px;
            }

            .loading-data {
                position: absolute;
                background-color: rgba(255,255,255,0.9);
                width: 100%;
                height: 100%;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                z-index: 2;
            }

            .filter {
                padding: 0 16px 0 0;
            }

            #filtering .container {
                align-items: flex-end;
            }

            .machines-column {
                opacity: 0.54;
                padding-right: 16px;
                text-align: left;

                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;

                text-align-last: right;
            }

            .cost-column {
                text-align: right;
                width: 30%;
            }

            .list {
                margin-top: 16px;
                margin-bottom: 32px;
                min-width: 300px;
                /*max-width: 600px;*/
            }

            /*.list > .layout.horizontal:nth-of-type(2n+1) {
                background-color: #f6f6f6;
            }*/

            .tag {
                vertical-align: middle;
                line-height: 1.6em;
                display: inline-block;
                background-color: #888;
                color: #fff;
                font-size: 14px;
                padding: 0 0.5em;
                margin: 0 1px;
                border-radius: 2px;
                letter-spacing: .4px;
                font-weight: 400;
                word-break: break-all;
                max-width: 250px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .tag.hidden-true {
                padding: 0;
            }

            .comparative {
                margin-bottom: 24px;
            }

            #test .test {
                margin: 20px;
                background-color: #eee;
            }

            .index {
                margin-right: 4px;
            }

        </style>

        <iron-media-query query="(min-width: 1180px)" query-matches="{{largescreen}}"></iron-media-query>

        <paper-material id="filtering" class="margin-botttom">
            <div class="container layout horizontal start">
                <div class="filter flex-1 self-start">
                    <div class="smaller">Time</div>
                    <paper-dropdown-menu no-label-float>
                        <paper-listbox id="window" slot="dropdown-content" attr-for-selected="value" selected="{{timeParams.window}}">
                            <paper-item value="hour">hourly</paper-item>
                            <paper-item value="day">daily</paper-item>
                            <paper-item value="week">weekly</paper-item>
                            <paper-item value="month">monthly</paper-item>
                            <paper-item value="quarter">quarterly</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu no-label-float>
                        <paper-listbox id="past" slot="dropdown-content" attr-for-selected="value" selected="{{timeParams.past}}">
                            <template is="dom-repeat" items="{{pastItems}}" as="past">
                                <paper-item value="[[past.value]]">[[past.text]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>
                <div class="filter flex-1" hidden$="[[!allowFilter]]">
                    <div class="smaller">Filter by</div>
                    <paper-dropdown-menu no-label-float>
                        <paper-listbox id="filterbyType" slot="dropdown-content" attr-for-selected="value" selected="{{filterby.type}}">
                            <paper-item value="stack">[[stackTerm]]</paper-item>
                            <paper-item value="cloud">Cloud</paper-item>
                            <paper-item value="tag">Tag</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu id="filterbyNameDd" no-label-float>
                        <paper-listbox id="filterbyName" slot="dropdown-content" attr-for-selected="value" selected="{{filterby.id}}">
                            <template is="dom-repeat" items="{{filterbyItems}}">
                                <paper-item value="[[item.id]]" data-name$="[[item.name]][[item.title]]">[[item.name]][[item.title]]</paper-item>
                            </template>
                            <paper-item disabled hidden$="{{!filterbyDisable}}">
                                <span hidden$="{{!filterby.type}}">no {{filterby.type}}s</span>
                                <span hidden$="{{filterby.type.length}}">Select type</span>
                            </paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>
                <paper-button class="inline baseline smaller" on-tap="clearFilter" disabled$="{{!filterby.id.length}}" hidden$="[[!allowFilter]]">clear</paper-button>
            </div>
        </paper-material>

        <paper-material id="quick-overview" class="margin-botttom">
            <div class="loading-data" hidden="{{!loadingDataCost}}">
            </div>
            <div id="quick-overview-data" class="quick-overview container layout horizontal">
                <div id="quick-overview-cost" class="flex-1">
                    <div class="smaller">Cost</div>
                    <h2 class="cost"><span class="sup">$</span>[[_formatMoney(costReport.cost)]]</h2>
                    <div class="smaller" hidden$="[[!isNotNull(costReport.comparative_cost)]]">
                        <span class$="[[diffText(costReport.comparative_cost)]]">
                            <span hidden$="[[!costReport.comparative_cost]]">[[abs(costReport.comparative_cost)]]%</span> [[diffText(costReport.comparative_cost)]]
                        </span> 
                        previous [[timeParams.window]]
                    </div>
                </div>
                <div id="quick-overview-machine_count" class="flex-1">
                    <div class="smaller">Machine Count</div>
                    <h2 class="cost"><span class="sup"></span>[[costReport.machine_count.unique]]</h2>
                    <!-- <div class="smaller">X more this [[timeParams.window]]</div> -->
                    <div class="smaller" hidden$="[[!isNotNull(costReport.comparative_machine_count.unique)]]">
                        <span class$="[[diffText(costReport.comparative_machine_count.unique)]]">
                            <span hidden$="[[!costReport.comparative_machine_count.unique]]">[[abs(costReport.comparative_machine_count.unique)]]%</span> [[diffText(costReport.comparative_machine_count.unique)]]
                        </span> 
                        previous [[timeParams.window]]
                    </div>
                </div>
                <div id="quick-overview-average_load" class="flex-1">
                    <div class="smaller">Average load</div>
                    <h2 class="cost"><span class="sup"></span>[[usageReport.load.mean]]</h2>
                    <div class="smaller" hidden$="[[!isNotNull(usageReport.comparative_load.mean)]]">
                        <span class$="[[diffText(usageReport.comparative_load.mean)]]">
                            <span hidden$="[[!usageReport.comparative_load.mean]]">[[abs(usageReport.comparative_load.mean)]] </span> [[diffText(usageReport.comparative_load.mean)]]
                        </span>
                        previous [[timeParams.window]]
                    </div>
                </div>
            </div>
        </paper-material>

        <paper-material id="graphRow">
            <div class="loading-data" hidden="{{!loadingDataCost}}">
                <paper-spinner active="{{loadingDataCost}}"></paper-spinner>
            </div>
            <div>
                <div class="head">
                    <h2 class="title">Cost Overview</h2>
                </div>

                <div class="comparative">Current cost: $[[_formatMoney(costReport.cost)]] ([[costReport.comparative_cost]]% from previous [[timeParams.window]]) | Cost per month: max: $[[_formatMoney(costReport.cost_per_month.max)]], avg: $[[_formatMoney(costReport.cost_per_month.mean)]], min: $[[_formatMoney(costReport.cost_per_month.min)]]</div>
                <div class="layout horizontal wrap">
                <div class="flex-1">
                    <div id="costGraph" class="graph" style$="width: [[costWidth]]px;"></div>
                </div>
                <div class="flex-1 layout vertical">
                    <div class="horizontal layout wrap">
                        <div class="flex-1">
                            <div class="smaller">Cost by Cloud</div>
                            <div id="drillcostgraph" class="graph" style$="width: [[drillCostWidth]]px;"></div>
                        </div>
                        <div class="flex-1">
                            <div id="costListByCloud" class="flex" hidden$="{{!costListByCloud}}">
                                <div class="list">
                                    <template is="dom-repeat" items="{{costListByCloud}}">
                                        <div class="layout horizontal">
                                            <span class="index">[[_index(index)]]. </span>
                                            <span class="flexchild name-col flex-2">
                                                [[item.name]]
                                            </span>
                                            <div class="machines-column flex-1" title="machines">
                                                [[item.machine_count.unique]]
                                                machines
                                            </div>
                                            <span class="cost-column">
                                                $[[_formatMoney(item.cost)]]
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div id="costListByStack" class="flex" hidden$="{{!costListByStack}}">
                            <div class="smaller">Cost by [[stackTerm]]</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{costListByStack}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            [[item.name]]
                                            <span hidden$="[[item.name.length]]">
                                                not in a [[stackTerm]]
                                            </span>
                                        </span>
                                        <div class="machines-column flex-1" title="machines">
                                            [[item.machine_count.unique]] 
                                            machines
                                        </div>
                                        <span class="cost-column">
                                            $[[_formatMoney(item.cost)]]
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div id="costListByTag" class="flex" hidden$="{{!costListByTag}}">
                            <div class="smaller">Cost by Tag</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{costListByTag}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            <span hidden$="[[!item.name.length]]" class$="tag hidden-[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">
                                                untagged
                                            </span>
                                        </span>
                                        <div class="machines-column flex-1" title="machines">
                                            [[item.machine_count.unique]] 
                                            machines
                                        </div>
                                        <span class="cost-column">
                                            $[[_formatMoney(item.cost)]]
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </div>
                </div>
            </div>


            </div>
        </paper-material>

        <paper-material>
            <div class="loading-data" hidden="{{!loadingDataUsage}}">
                <paper-spinner active="{{loadingDataUsage}}"></paper-spinner>
            </div>
            <div>
                <div class="head">
                    <h2 class="title">Utilisation Overview</h2>
                </div>
                <div class="comparative">
                    [[usageReport.load.max]] MAX Load
                    ([[usageReport.comparative_load.max]]% from previous [[timeParams.window]]) |
                    [[usageReport.load.max]] MIN Load
                    ([[usageReport.comparative_load.min]]% from previous [[timeParams.window]]) |
                    [[usageReport.load.max]] AVG Load
                    ([[usageReport.comparative_load.mean]]% from previous [[timeParams.window]]) 
                    <br/>
                    [[usageReport.load.max]] MAX cores
                    ([[usageReport.comparative_cores.max]]% from previous [[timeParams.window]]) |
                    [[usageReport.load.max]] MIN cores
                    ([[usageReport.comparative_cores.min]]% from previous [[timeParams.window]]) |
                    [[usageReport.load.max]] AVG Load
                    ([[usageReport.comparative_cores.mean]]% from previous [[timeParams.window]])
                </div>
                
                <div class="layout horizontal wrap">
                    <div class="flex-1">
                        <div id="usageGraph" class="graph" style$="width: [[usageWidth]]px;"></div>
                    </div>
                    <div class="flex-1">

                        <div id="usageListByCloud" class="flex" hidden$="{{!usageListByCloud}}">
                            <div class="smaller">Load by Cloud</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{usageListByCloud}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            [[item.name]]
                                        </span>
                                        <div class="machines-column">
                                            [[item.machine_count.unique]] machines
                                        </div>
                                        <div class="machines-column">
                                            [[item.cores.mean]] cores
                                        </div>
                                        <span class="cost-column">
                                            [[item.load.mean]] load
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div id="usageListByStack" class="flex" hidden$="{{!usageListByStack}}">
                            <div class="smaller">Load by [[stackTerm]]</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{usageListByStack}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            [[item.name]]
                                            <span hidden$="[[item.name.length]]">
                                                not in a [[stackTerm]]
                                            </span>
                                        </span>
                                        <div class="machines-column">
                                            [[item.machine_count.unique]] machines
                                        </div>
                                        <div class="machines-column">
                                            [[item.cores.mean]] cores
                                        </div>
                                        <span class="cost-column">
                                            [[item.load.mean]] load
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div id="usageListByTag" class="flex" hidden$="{{!usageListByTag}}">
                            <div class="smaller">Load by Tag</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{usageListByTag}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2 tags">
                                            <span hidden$="[[!item.name.length]]" class$="tag hidden-[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">
                                                untagged
                                            </span>
                                        </span>
                                        <div class="machines-column">
                                            [[item.machine_count.unique]] machines
                                        </div>
                                        <div class="machines-column">
                                            [[item.cores.mean]] cores
                                        </div>
                                        <span class="cost-column">
                                            [[item.load.mean]] load
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </paper-material>

        <paper-material>
            <div class="loading-data" hidden="{{!loadingDataCost}}">
                <paper-spinner active="{{loadingDataCost}}"></paper-spinner>
            </div>
            <div>
                <div class="head">
                    <h2 class="title">Machines Overview</h2>
                </div>
                <div class="comparative">
                    [[costReport.machine_count.unique]] UNIQUE machines ([[costReport.comparative_machine_count.unique]]% from previous [[timeParams.window]]) | MAX [[costReport.machine_count.max]] machines ([[costReport.comparative_machine_count.max]]% from previous [[timeParams.window]]) 
                    <br/>
                    MIN [[costReport.machine_count.min]] machines ([[costReport.comparative_machine_count.min]]% from previous [[timeParams.window]]) | AVG [[costReport.machine_count.mean]] machines ([[costReport.comparative_machine_count.mean]]% from previous [[timeParams.window]])
                </div>
                <div class="layout horizontal wrap">
                    <div class="flex-1">
                        <div id="machinesGraph" class="graph" style$="width: [[machinesWidth]]px;"></div>
                    </div>
                    <div class="flex-1">

                        <div id="machinesListByCloud" class="flex" hidden$="{{!machinesListByCloud}}">
                            <div class="smaller">Machines by Cloud</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{machinesListByCloud}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            [[item.name]]
                                        </span>
                                        <div class="machines-column flex-1" title="machines">
                                            [[item.machine_count.unique]] 
                                            machines
                                        </div>
                                        <span class="cost-column">
                                            $[[_formatMoney(item.cost)]]
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div id="machinesListByStack" class="flex" hidden$="{{!machinesListByStack}}">
                            <div class="smaller">Machines by [[stackTerm]]</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{machinesListByStack}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            [[item.name]]
                                            <span hidden$="[[item.name.length]]">
                                                not in a [[stackTerm]]
                                            </span>
                                        </span>
                                        <div class="machines-column flex-1" title="machines">
                                            [[item.machine_count.unique]] 
                                            machines
                                        </div>
                                        <span class="cost-column">
                                            $[[_formatMoney(item.cost)]]
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div id="machinesListByTag" class="flex" hidden$="{{!machinesListByTag}}">
                            <div class="smaller">Machines by Tag</div>
                            <div class="list">
                                <template is="dom-repeat" items="{{machinesListByTag}}">
                                    <div class="layout horizontal">
                                        <span class="index">[[_index(index)]]. </span>
                                        <span class="flexchild name-col flex-2">
                                            <span hidden$="[[!item.name.length]]" class$="tag hidden-[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">
                                                untagged
                                            </span>
                                        </span>
                                        <div class="machines-column flex-1" title="machines">
                                            [[item.machine_count.unique]] 
                                            machines
                                        </div>
                                        <span class="cost-column">
                                            $[[_formatMoney(item.cost)]]
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </paper-material>


        <iron-ajax id="cloudsAjax" method="GET" url$="[[uri]]/api/v1/clouds" headers$='{"Authorization": "[[token]]"}' handle-as="json"
            loading={{loading}} on-response="handleResponseClouds" on-error="handleError"></iron-ajax>

        <iron-ajax id="stacksAjax" method="GET" url$="[[uri]]/api/v1/stacks" headers$='{"Authorization": "[[token]]"}' handle-as="json"
            loading={{loading}} on-response="handleResponseStacks" on-error="handleError"></iron-ajax>

        <iron-ajax id="costReportAjax" method="GET" url$="[[uri]]/api/v1/report" headers$='{"Authorization": "[[token]]"}' handle-as="json"
            loading="{{loadingDataCost}}" on-response="handleResponseCostReport" on-error="handleError" params=[[params]]></iron-ajax>

        <iron-ajax id="usageReportAjax" method="GET" url="[[uri]]/api/v1/report?type=load" headers$='{"Authorization": "[[token]]"}'
            handle-as="json" loading="{{loadingDataUsage}}" on-response="handleResponseUsageReport" on-error="handleError" params=[[params]]></iron-ajax>

    </template>

    <script>
    Polymer({
        is: 'mist-insights',

        properties: {
            model: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            token: {
                type: String,
                value: '',
            },
            uri: {
                type: String,
                value: 'https://mist.io'
            },
            largescreen: {
                type: Boolean,
                reflectToAttribute: true
            },
            params: {
                type: Object
            },
            timeParams: {
                type: Object,
                value: function () {
                    return {
                        window: "month",
                        past: "0"
                    }
                }
            },
            filterby: {
                type: Object,
                value: function () {
                    return {
                        type: '',
                        name: '',
                        id: ''
                    };
                }
            },
            clouds: Array,
            stacks: Array,
            tags: Array,
            costReport: Object,
            usageReport: Object,
            costGraph: Object,
            costGraphOptions: {
                type: Object,
                value: function () {
                    return {
                        tooltip: {
                            trigger: 'axis',
                            formatter: "{b}: <br/>${c}",
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            }
                        },
                        legend: {
                            data: ['Cost per month']
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: [{
                            type: 'category',
                            boundaryGap: false,
                            data: []
                        }],
                        yAxis: [{
                            type: 'value'
                        }],
                        series: [{
                            name: 'Cost',
                            type: 'line',
                            stack: 'f',
                            areaStyle: {
                                normal: {
                                    color: "rgba(0,155,155,0.2)"
                                }
                            },
                            lineStyle: {
                                normal: {
                                    color: "rgba(0,155,155,1)"
                                }
                            },
                            itemStyle: {
                                normal: {
                                    borderColor: "rgba(0,155,155,1)"
                                }
                            },
                            data: []
                        }]
                    }
                }
            },
            drillcostgraph: Object,
            drillcostgraphOptions: {
                type: Object,
                value: {
                    tooltip: {
                        trigger: 'item',
                        formatter: "{b} {a}: <br/>${c} ({d}%)"
                    },
                    legend: {
                        orient: 'vertical',
                        x: 'left',
                        data:[1,2,3]
                    },
                    series: [
                        {
                            name:'cost',
                            type:'pie',
                            center: ['65%', '40%'],
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: false,
                            label: {
                                normal: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    show: true,
                                    textStyle: {
                                        fontSize: '30',
                                        fontWeight: 'bold'
                                    }
                                }
                            },
                            labelLine: {
                                normal: {
                                    show: false
                                }
                            },
                            data:[1,2,3]
                        }
                    ]
                }
            },
            costListByCloud: Array,
            costListByStack: Array,
            costListByTag: Array,
            usageListByCloud: Array,
            usageListByStack: Array,
            usageListByTag: Array,
            usageGraph: Object,
            usageGraphOptions: {
                type: Object,
                value: function () {
                    return {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            }
                        },
                        legend: {
                            data: [{
                                name: 'Load',
                                textStyle: "rgba(0,155,155,1)",
                            }, {
                                name: 'Cores',
                                textStyle: "rgba(250,128,114,1)",
                            }]
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: [{
                            type: 'category',
                            boundaryGap: false,
                            data: ['1', '2', '3', '4']
                        }],
                        yAxis: [{
                            type: 'value'
                        }],
                        series: [{
                                name: 'Cores',
                                type: 'line',
                                stack: 'f',
                                areaStyle: {
                                    normal: {
                                        color: "rgba(0,155,155,0.2)"
                                    }
                                },
                                lineStyle: {
                                    normal: {
                                        color: "rgba(0,155,155,1)"
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        borderColor: "rgba(0,155,155,1)"
                                    }
                                },
                                data: [120, 132, 101, 134]
                            },
                            {
                                name: 'Load',
                                type: 'line',
                                stack: 'g',
                                areaStyle: {
                                    normal: {
                                        color: "rgba(250,128,114,0.2)"
                                    }
                                },
                                lineStyle: {
                                    normal: {
                                        color: "rgba(250,128,114,1)"
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        borderColor: "rgba(250,128,114,1)"
                                    }
                                },
                                data: [120, 132, 101, 134]
                            }
                        ]
                    }
                }
            },
            machinesListByCloud: {
                type: Array,
                computed: 'sortByMachines(costListByCloud)'
            },
            machinesListByStack: {
                type: Array,
                computed: 'sortByMachines(costListByStack)'
            },
            machinesListByTag: {
                type: Array,
                computed: 'sortByMachines(costListByTag)'
            },
            machinesGraph: Object,
            machinesGraphOptions: {
                type: Object,
                value: {
                    color: ["rgba(0,155,155,0.2)"],
                    borderColor: ["rgba(0,155,155,1)"],
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [{
                        type: 'category',
                        data: ['Mon'],
                        axisTick: {
                            alignWithLabel: true
                        }
                    }],
                    yAxis: [{
                        type: 'value'
                    }],
                    series: [{
                        name: 'machines',
                        type: 'bar',
                        barWidth: '60%',
                        data: [10]
                    }]
                }
            },
            period: String,
            costWidth: Number,
            drillCostWidth: Number,
            usageWidth: Number,
            machinesWidth: Number,
            cloud: String,
            stack: String,
            tag: String,
            allowFilter: {
                type: Boolean,
                computed: '_computeAllowFilter(cloud, stack, tag)',
                value: true
            },
            stackTerm: {
                type: String,
                value: 'stack'
            }
        },

        listeners: {
            'resize-insights-graphs' : 'updateChartWidth'
        },

        observers: [
            'computePastItems(timeParams.*)',
            'updateCostData(costReport.history)',
            'updateUsageData(usageReport.history)',
            'computeFilterbyItems(filterby.*)',
            'combineParams(timeParams.*, filterby.*)',
            'updateCostDrillData(costReport.group_by, filterby.id)',
        ],

        attached: function () {
            if (typeof echarts == 'undefined')
                this.importHref(this.resolveUrl('echarts-import.html'), this.initCharts, function (e) {
                    console.error('Failed to load echarts', e);
                }, true);
            else
                this.initCharts();

            if (!this.token)
                this.uri = '';

            if (this.token) {
                // this.$.cloudsAjax.generateRequest();
                // this.$.stacksAjax.generateRequest();
                // this.$.tagsAjax.generateRequest();
            }

            if (this.period) {
                this.set('timeParams.window', this.period);
            }

            if (this.cloud || this.stack || this.tag) {
                if (this.cloud){
                    this.set('filterby.type', 'cloud');
                    this.set('filterby.id', this.cloud);
                }
                else if (this.stack){
                    this.set('filterby.type', 'stack');
                    this.set('filterby.id', this.stack);
                }
                else if (this.tag){
                    this.set('filterby.type', 'tag');
                    this.set('filterby.id', this.tag);
                }
            }

            // this.$.costReportAjax.generateRequest();
            // this.$.usageReportAjax.generateRequest();
        },

        _computeAllowFilter: function(cloud, stack, tag){
            this.set('allowFilter', cloud || stack || tag ? true : false);
        },

        initCharts: function () {
            var colorPalette = ['#607D8B', '#d96557', '#3F51B5', '#009688', '#795548', '#8c76d1', '#795548', '#0277BD', '#0099cc', '#424242', '#D48900', '#43A047', '#2F2F3E'];
            echarts.registerTheme('insights', {
                color: colorPalette,
                backgroundColor: 'transparent',
                graph: {
                    color: colorPalette
                }
            });
            this.costGraph = echarts.init(this.$.costGraph, 'insights');
            this.machinesGraph = echarts.init(this.$.machinesGraph, 'insights');
            this.usageGraph = echarts.init(this.$.usageGraph, 'insights');
            this.drillcostgraph = echarts.init(this.$.drillcostgraph);
            this.updateChartWidth();
            console.log('initialized charts');
        },

        isNotNull: function(value) {
            return value != null;
        },

        abs: function(perc) {
            return Math.abs(perc)
        },
        diffText: function(perc) {
            if (perc == null)
                return ''
            else if (perc == 0)
                return 'equal to'
            else
                return perc > 0 ? 'above' : 'below'
        },

        updateCostData: function (history) {
            var costData = [],
                machinesData = [],
                labels = [];
            if (history) {
                labels = history.map(function (datapoint) {
                    if (['day', 'hour'].indexOf(this.timeParams.window) != -1)
                        return moment(datapoint.date).format('HH:mm').toString();
                    else
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                }, this);
                costData = history.map(function (datapoint) {
                    return datapoint.cost_per_month;
                });
                machinesData = history.map(function (datapoint) {
                    return datapoint.machine_count;
                });
            }

            this.set('costGraphOptions.xAxis.0.data', labels);
            this.set('costGraphOptions.series.0.data', costData);
            if (this.costGraph)
                this.costGraph.setOption(this.costGraphOptions);

            this.set('machinesGraphOptions.xAxis.0.data', labels);
            this.set('machinesGraphOptions.series.0.data', machinesData);
            if (this.machinesGraph)
                this.machinesGraph.setOption(this.machinesGraphOptions);
        },

        updateUsageData: function (history) {
            var usageData = [],
                coresData = [],
                labels = [],
                usageListByCloud,
                usageListByStack,
                usageListByTag;

            if (history) {
                labels = history.map(function (datapoint) {
                    if (['day', 'hour'].indexOf(this.timeParams.window) != -1)
                        return moment(datapoint.date).format('HH:mm').toString();
                    else
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                }, this);
                usageData = history.map(function (datapoint) {
                    return datapoint.load;
                });
                coresData = history.map(function (datapoint) {
                    return datapoint.cores;
                });
            }

            this.set('usageGraphOptions.xAxis.0.data', labels);
            this.set('usageGraphOptions.series.0.data', coresData);
            this.set('usageGraphOptions.series.1.data', usageData);
            if (this.usageGraph)
                this.usageGraph.setOption(this.usageGraphOptions);

            if (this.usageReport.group_by['stack'])
                usageListByCloud = this.usageReport.group_by['cloud'].sort(function(a,b){ return a.load.mean < b.load.mean});
            if (this.usageReport.group_by['stack'])
                usageListByStack = this.usageReport.group_by['stack'].sort(function(a,b){ return a.load.mean < b.load.mean});
            if (this.usageReport.group_by['tag'])
                usageListByTag = this.usageReport.group_by['tag'].sort(function(a,b){ return a.load.mean < b.load.mean});

            // fill in cost lists
            this.set('usageListByCloud', usageListByCloud || false);
            this.set('usageListByStack', usageListByStack || false);
            this.set('usageListByTag', usageListByTag || false);

            console.log('updated usage data');
        },

        updateCostDrillData: function(groupby, filterbyname) {            
            var costRingData = [],
                costRingLabels = [],
                costListByCloud,
                costListByStack,
                costListByTag;

            if (this.costReport && this.costReport.group_by) {
                costRingData = this.costReport.group_by['cloud'].map(function(point){
                    return {value: point.cost, name: point.name};
                }, this);
                costRingLabels = this.costReport.group_by['cloud'].map(function(point){
                    return point.name;
                }, this);

                if (this.costReport.group_by['cloud']){
                    costListByCloud = this.sortByCost(this.costReport.group_by['cloud']);
                }
                if (this.costReport.group_by['stack']){
                    costListByStack = this.sortByCost(this.costReport.group_by['stack']);
                }
                if (this.costReport.group_by['tag']){
                    costListByTag = this.sortByCost(this.costReport.group_by['tag']);
                }
            }

            // fill in ring
            this.set('drillcostgraphOptions.series.0.data', costRingData);
            this.set('drillcostgraphOptions.legend.data', costRingLabels);
            if (this.drillcostgraph)
                this.drillcostgraph.setOption(this.drillcostgraphOptions);

            // fill in cost lists
            this.set('costListByCloud', costListByCloud || false);
            this.set('costListByStack', costListByStack || false);
            this.set('costListByTag', costListByTag || false);

        },

        sortByMachines: function(array){
            if (array) {
                var ret = array.slice(0);
                return ret.sort(function(a,b){ return a.machine_count.unique < b.machine_count.unique})
            }
            return false;
        },

        sortByCost: function(array){
            if (array) {
                var ret = array.slice(0);                
                return ret.sort(function(a,b){ return a.cost < b.cost})
            }
            return false;
        },

        computePastItems: function (timeParamsChangeRecord) {
            // console.log("loadingData", this.loadingData);
            var items = [];
            if (this.timeParams.window == "hour") {
                items.push({
                    value: 0,
                    text: "this hour"
                });
                items.push({
                    value: 1,
                    text: "last hour"
                });
                for (var i = 2; i < 11; i++) {
                    items.push({
                        value: i,
                        text: i + " hours ago"
                    });
                }
            } else if (this.timeParams.window == "day") {
                items.push({
                    value: 0,
                    text: "today"
                });
                items.push({
                    value: 1,
                    text: "yesterday"
                });
                for (var i = 2; i < 11; i++) {
                    items.push({
                        value: i,
                        text: i + " days ago"
                    });
                }
            } else if (this.timeParams.window == "week") {
                items = [{
                    value: '0',
                    text: 'this week'
                }, {
                    value: '1',
                    text: 'last week'
                }, {
                    value: '2',
                    text: 'two weeks ago'
                }, {
                    value: '3',
                    text: 'three weeks ago'
                }]
            } else if (this.timeParams.window == "month") {
                for (var i = 0; i < 12; i++) {
                    var t = '';
                    if (i == 0)
                        t = 'this month';
                    else if (i == 1)
                        t = 'last month';
                    else
                        t = i + ' months ago';

                    items.push({
                        value: i,
                        text: t
                    })
                }
            } else if (this.timeParams.window == "quarter") {
                items = [{
                    value: '0',
                    text: 'current quarter'
                }, {
                    value: '1',
                    text: 'previous quarter'
                }, {
                    value: '2',
                    text: '2 quarters ago'
                }, {
                    value: '3',
                    text: '3 quarters ago'
                }]
            }

            this.set('pastItems', items);

            // if window changed reset selected past
            if (timeParamsChangeRecord.path == 'timeParams.window') {
                this.set('timeParams.past', '0');
                this.async(function () {
                    this.$.past.selected = -1;
                    this.$.past.selected = 0;
                }, 100, this)
            }
        },
        updateFilterItems: function(group_by) {
            var items = [], 
                clouds = [], stacks = [], tags = [];
            if (this.token){
                clouds = this.costReport.group_by.cloud || [];
                stacks = this.costReport.group_by.stack || [];
                tags = this.costReport.group_by.tag || [];
            }
            else if (this.model) {
                clouds = this.model.cloudsArray;
                stacks = this.model.stacksArray;
                tags = this.model.machinesArray.filter(function(m){
                        return m.tags.length > 0
                    }).map(function(m){
                        for (var i=0; i < m.tags.length; i++){
                            var postfix = '';
                            if (m.tags[i].value != ''){
                                postfix = '='+m.tags[i].value;
                            }
                            return {
                                'name': m.tags[i].key+postfix,
                                'id': m.tags[i].key+postfix,
                                'val': m.tags[i].val
                            };
                        }
                    });
                var names = tags.map(function(t){
                    return t.name;
                });
                tags = tags.filter(function(t, ind){
                    return names.indexOf(t.name) == ind;
                });
            }

            this.set('clouds', clouds);
            this.set('stacks', stacks.filter(function(c){return c.name != ""}));
            this.set('tags', tags.filter(function(c){return c.name != ""}));

        },
        computeFilterbyItems: function (filterby) {
            var items = [];
            if (filterby.path == 'filterby.type'){
                if (this.filterby.type == 'stack')
                    items = this.stacks;
                else if (this.filterby.type == 'cloud')
                    items = this.clouds;
                else if (this.filterby.type == 'tag')
                    items = this.tags;
                else
                    items = [];

                if (!items || !items.length){
                    this.set('filterbyDisable', true);
                }
                else {
                    this.set('filterbyDisable', false);
                }

                this.set('filterbyItems',items);
            }

            // if filterby changed reset selected item
            // console.log(filterby.path);
            if (filterby.path == 'filterby.type'){
                this.set('filterby.name', '');
                this.async(function(){
                    this.$.filterbyName.selected = '';
                }, 100, this)
            }
            // if filterby id changed update name
            if (filterby.path == 'filterby.id'){
                this.set('filterby.name', this.computeName(filterby.value));
            }

        },

        combineParams: function(time, filter) {
            // console.log('filter path', filter.path, this.allowFilter);

            // dont update params so dont request, if user changes window, type, name or has not specified filter by id
            // also dont request for past = -1

            if (filter.path == 'filterby.type' || filter.path == 'filterby.name' || time.path == 'timeParams.window' || (filter.path == 'filterby.id' && filter.value == "") || time.value == "-1") {
                // console.log('dont send ', this.params);
            }
            else if (filter.path == 'filterby.id' || (filter.path == 'filterby' && this.allowFilter)){
                var p = {
                    window: this.timeParams.window,
                    past: this.timeParams.past
                };

                if (this.filterby.type != '' && this.filterby.id != ''){
                    p[this.filterby.type] = this.filterby.id;
                }
                
                this.set('params', p);
                this.$.costReportAjax.generateRequest();
                // console.log('p send ', p, this.params);
            }
        },

        computeName: function(id){
            if (id){
                if (this.filterby.type == 'tag') {
                    return id;
                }
                else if (this.filterby.type == 'cloud') {
                    if (!this.token)
                        return this.model.clouds[id].title;
                    else 
                        return this.clouds && this.clouds.find(function(c){
                            return c.id == id;
                        }).name;
                }
                else if (this.filterby.type == 'stack') {
                    if (!this.token)
                        return this.model.stacks[id].name;
                    else
                        return this.stacks && this.stacks.find(function(s){
                            return s.id == id;
                        }).name;
                }
            }
            else {
                return '';
            }
        },

        clearFilter: function(e){
            this.set('filterby', {
                type: '',
                name: '',
                id: ''
            });
        },

        updateChartWidth: function(){
            var parentWidth = this.$.graphRow.offsetWidth - 50;

            if (parentWidth/2 > 400) {
                this.set('costWidth',parentWidth/2);
                this.set('usageWidth',parentWidth/2);
                this.set('machinesWidth',parentWidth/2);
                if (parentWidth/4 > 300)
                    this.set('drillCostWidth',parentWidth/4);
                else
                    this.set('drillCostWidth',parentWidth/2);
            }
            else {
                this.set('costWidth',parentWidth);
                this.set('drillCostWidth',parentWidth);
                this.set('usageWidth',parentWidth);
                this.set('machinesWidth',parentWidth);
            }

            this.resizeGraphs();
        },

        resizeGraphs: function(){
            console.log('resizeGraphs');
            if (this.costGraph)
                this.costGraph.resize();
            if (this.drillcostgraph)
                this.drillcostgraph.resize();
            if (this.usageGraph)
                this.usageGraph.resize();
            if (this.machinesGraph)
                this.machinesGraph.resize();
        },

        _index: function(ind) {
            return ind+1;
        },

        _formatMoney: function(inp){
            return inp.formatMoney(2);
        },

        handleResponse: function (e) {
            console.log('handleResponse');
        },

        handleResponseClouds: function (e) {
            console.log('handleResponseClouds');
            this.set('clouds', e.detail.xhr.response);
        },

        handleResponseStacks: function (e) {
            console.log('handleResponseStacks');
            this.set('stacks', e.detail.xhr.response);
        },

        handleResponseCostReport: function (e) {
            console.log('handleResponseCostReport');
            this.set('costReport', e.detail.xhr.response);
            
            if (this.filterby.type == '')
                this.updateFilterItems(this.costReport.group_by);

            this.$.usageReportAjax.generateRequest();
        },

        handleResponseUsageReport: function (e) {
            console.log('handleResponseUsageReport');
            this.set('usageReport', e.detail.xhr.response);
        },

        handleError: function (e) {
            console.log('handleError');
        }
    });

(function() {
    var throttle = function(type, name, obj) {
        obj = obj || window;
        var running = false;
        var func = function() {
            if (running) { return; }
            running = true;
             requestAnimationFrame(function() {
                obj.dispatchEvent(new CustomEvent(name));
                running = false;
            });
        };
        obj.addEventListener(type, func);
    };

    /* init - you can init any event */
    throttle("resize", "optimizedResize");
})();

// handle event
window.addEventListener("optimizedResize", function() {
    document.querySelector('mist-insights').fire('resize-insights-graphs')
});

Number.prototype.formatMoney = function(c, d, t){
var n = this,
    c = isNaN(c = Math.abs(c)) ? 2 : c,
    d = d == undefined ? "." : d,
    t = t == undefined ? "," : t,
    s = n < 0 ? "-" : "",
    i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))),
    j = (j = i.length) > 3 ? j % 3 : 0;
   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
 };
  </script>
</dom-module>