<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<script src="../moment/moment.js"></script>
<!--
`mist-insights`


@demo demo/index.html
-->

<dom-module id="mist-insights">
    <template>
        <style include="default-theme">
             :host {
                display: block;
                font-size: 16px;
            }

            #graphRow[largescreen] {
                display: flex;
            }

            #graphRow[largescreen] .block+.block {
                padding-left: 48px;
            }

            .graph {
                width:100%;
                min-height:300px;
            }

            .uppercase, paper-item {
                text-transform: uppercase;
            }

        </style>

        <iron-media-query query="(min-width: 1180px)" query-matches="{{largescreen}}"></iron-media-query>

        <paper-material id="filtering" class="margin-botttom">
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <div class="smaller">Time</div>
                    <paper-dropdown-menu no-label-float>
                        <paper-listbox id="window" slot="dropdown-content" class="uppercase" attr-for-selected="value" selected="{{timeParams.window}}">
                            <paper-item value="hour">hourly</paper-item>
                            <paper-item value="day">daily</paper-item>
                            <paper-item value="week">weekly</paper-item>
                            <paper-item value="month">monthly</paper-item>
                            <paper-item value="quarter">quarterly</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu no-label-float>
                        <paper-listbox id="past" slot="dropdown-content" class="uppercase" attr-for-selected="value" selected="{{timeParams.past}}">
                            <template is="dom-repeat" items="{{pastItems}}" as="past">
                                <paper-item value="[[past.value]]">[[past.text]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>
                <div class="flexchild">
                    <div class="smaller">Filter by</div>
                    <paper-dropdown-menu class="uppercase" class="uppercase" no-label-float>
                        <paper-listbox id="filterbyType" slot="dropdown-content" attr-for-selected="value" selected="{{filterby.type}}">
                            <paper-item value="stack">Stack</paper-item>
                            <paper-item value="cloud">Cloud</paper-item>
                            <paper-item value="tag">Tag</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu id="filterbyNameDd" class="uppercase" no-label-float>
                        <paper-listbox id="filterbyName" slot="dropdown-content" attr-for-selected="value" selected="{{filterby.id}}">
                            <template is="dom-repeat" items="{{filterbyItems}}">
                                <paper-item value="[[item.id]]" data-name$="[[item.name]][[item.title]]">[[item.name]][[item.title]]</paper-item>
                            </template>
                            <paper-item disabled hidden$="{{!filterbyDisable}}">
                                <span hidden$="{{!filterby.type}}">no {{filterby.type}}s</span>
                                <span hidden$="{{filterby.type.length}}">Select type</span>
                            </paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-button class="inline baseline smaller" on-tap="clearFilter" disabled$="{{!filterby.id.length}}">clear</paper-button>
                </div>
            </div>
        </paper-material>

        <!-- <h2>[[clouds]]!</h2> -->

        <h2>Cost per month</h2>
        <div id="costGraph" class="graph"></div>

        <h2>Load</h2>
        <div id="usageGraph" class="graph"></div>

        <h2>Machines Count</h2>
        <div id="machinesGraph" class="graph"></div>



        <iron-ajax id="cloudsAjax" method="GET" url$="[[uri]]/api/v1/clouds" headers$='{"Authorization": "[[token]]"}' handle-as="json"
            loading={{loading}} on-response="handleResponseClouds" on-error="handleError"></iron-ajax>

        <iron-ajax id="costReportAjax" method="GET" url$="[[uri]]/api/v1/report" headers$='{"Authorization": "[[token]]"}' handle-as="json"
            loading="{{loadingDataCost}}" on-response="handleResponseCostReport" on-error="handleError" params=[[params]]></iron-ajax>

        <iron-ajax id="usageReportAjax" method="GET" url="[[uri]]/api/v1/report?type=load" headers$='{"Authorization": "[[token]]"}'
            handle-as="json" loading="{{loadingDataUsage}}" on-response="handleResponseUsageReport" on-error="handleError" params=[[params]]></iron-ajax>

    </template>

    <script>
    Polymer({
        is: 'mist-insights',

        properties: {
            model: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            token: {
                type: String,
                value: '',
            },
            uri: {
                type: String,
                value: 'https://mist.io'
            },
            largescreen: Boolean,
            params: {
                type: Object
            },
            timeParams: {
                type: Object,
                value: function () {
                    return {
                        window: "day",
                        past: "0"
                    }
                }
            },
            filterby: {
                type: Object,
                value: function () {
                    return {
                        type: '',
                        name: '',
                        id: ''
                    };
                }
            },
            clouds: Array,
            stacks: Array,
            costReport: Object,
            usageReport: Object,
            costGraph: Object,
            costGraphOptions: {
                type: Object,
                value: function () {
                    return {
                        tooltip: {
                            trigger: 'axis',
                            formatter: "{b}: <br/>${c}",
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            }
                        },
                        legend: {
                            data: ['Cost per month']
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: [{
                            type: 'category',
                            boundaryGap: false,
                            data: []
                        }],
                        yAxis: [{
                            type: 'value'
                        }],
                        series: [{
                            name: 'Cost',
                            type: 'line',
                            stack: 'f',
                            areaStyle: {
                                normal: {
                                    color: "rgba(0,155,155,0.2)"
                                }
                            },
                            lineStyle: {
                                normal: {
                                    color: "rgba(0,155,155,1)"
                                }
                            },
                            itemStyle: {
                                normal: {
                                    borderColor: "rgba(0,155,155,1)"
                                }
                            },
                            data: []
                        }]
                    }
                }
            },
            usageGraph: Object,
            usageGraphOptions: {
                type: Object,
                value: function () {
                    return {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            }
                        },
                        legend: {
                            data: [{
                                name: 'Load',
                                textStyle: "rgba(0,155,155,1)",
                            }, {
                                name: 'Cores',
                                textStyle: "rgba(250,128,114,1)",
                            }]
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: [{
                            type: 'category',
                            boundaryGap: false,
                            data: ['1', '2', '3', '4']
                        }],
                        yAxis: [{
                            type: 'value'
                        }],
                        series: [{
                                name: 'Cores',
                                type: 'line',
                                stack: 'f',
                                areaStyle: {
                                    normal: {
                                        color: "rgba(0,155,155,0.2)"
                                    }
                                },
                                lineStyle: {
                                    normal: {
                                        color: "rgba(0,155,155,1)"
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        borderColor: "rgba(0,155,155,1)"
                                    }
                                },
                                data: [120, 132, 101, 134]
                            },
                            {
                                name: 'Load',
                                type: 'line',
                                stack: 'g',
                                areaStyle: {
                                    normal: {
                                        color: "rgba(250,128,114,0.2)"
                                    }
                                },
                                lineStyle: {
                                    normal: {
                                        color: "rgba(250,128,114,1)"
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        borderColor: "rgba(250,128,114,1)"
                                    }
                                },
                                data: [120, 132, 101, 134]
                            }
                        ]
                    }
                }
            },
            machinesGraph: Object,
            machinesGraphOptions: {
                type: Object,
                value: {
                    color: ["rgba(0,155,155,0.2)"],
                    borderColor: ["rgba(0,155,155,1)"],
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [{
                        type: 'category',
                        data: ['Mon'],
                        axisTick: {
                            alignWithLabel: true
                        }
                    }],
                    yAxis: [{
                        type: 'value'
                    }],
                    series: [{
                        name: 'machines',
                        type: 'bar',
                        barWidth: '60%',
                        data: [10]
                    }]
                }
            }
        },

        observers: [
            'computePastItems(timeParams.*)',
            'updateCostData(costReport.history)',
            'updateUsageData(usageReport.history)',
            'computeFilterbyItems(filterby.*)',
            'combineParams(timeParams.*, filterby.*)'
        ],

        attached: function () {
            if (typeof echarts == 'undefined')
                this.importHref(this.resolveUrl('echarts-import.html'), this.initCharts, function (e) {
                    console.error('Failed to load echarts', e);
                }, true);
            else
                this.initCharts();

            if (!this.token)
                this.uri = '';

            if (this.token) {
                this.$.cloudsAjax.generateRequest();
                // this.$.stacksAjax.generateRequest();
                // this.$.tagsAjax.generateRequest();
            }

            this.$.costReportAjax.generateRequest();
            this.$.usageReportAjax.generateRequest();
        },

        initCharts: function () {
            var colorPalette = ['#607D8B', '#d96557', '#3F51B5', '#009688', '#795548', '#8c76d1', '#795548', '#0277BD', '#0099cc', '#424242', '#D48900', '#43A047', '#2F2F3E'];
            echarts.registerTheme('insights', {
                color: colorPalette,
                backgroundColor: 'transparent',
                graph: {
                    color: colorPalette
                }
            });
            this.costGraph = echarts.init(this.$.costGraph, 'insights');
            this.machinesGraph = echarts.init(this.$.machinesGraph, 'insights');
            this.usageGraph = echarts.init(this.$.usageGraph, 'insights');
            /*this.drillcostgraph = echarts.init(this.$.drillcostgraph);
            this.updateChartWidth(e);*/
            console.log('initialized charts');
        },

        updateCostData: function (history) {
            var costData = [],
                machinesData = [],
                labels = [];
            if (history) {
                labels = history.map(function (datapoint) {
                    if (['day', 'hour'].indexOf(this.timeParams.window) != -1)
                        return moment(datapoint.date).format('HH:mm').toString();
                    else
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                }, this);
                costData = history.map(function (datapoint) {
                    return datapoint.cost_per_month;
                });
                machinesData = history.map(function (datapoint) {
                    return datapoint.machine_count;
                });
            }

            this.set('costGraphOptions.xAxis.0.data', labels);
            this.set('costGraphOptions.series.0.data', costData);
            if (this.costGraph)
                this.costGraph.setOption(this.costGraphOptions);

            this.set('machinesGraphOptions.xAxis.0.data', labels);
            this.set('machinesGraphOptions.series.0.data', machinesData);
            if (this.machinesGraph)
                this.machinesGraph.setOption(this.machinesGraphOptions);
        },

        updateUsageData: function (history) {
            var usageData = [],
                coresData = [],
                labels = [];
            if (history) {
                labels = history.map(function (datapoint) {
                    if (['day', 'hour'].indexOf(this.timeParams.window) != -1)
                        return moment(datapoint.date).format('HH:mm').toString();
                    else
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                }, this);
                usageData = history.map(function (datapoint) {
                    return datapoint.load;
                });
                coresData = history.map(function (datapoint) {
                    return datapoint.cores;
                });
            }

            this.set('usageGraphOptions.xAxis.0.data', labels);
            this.set('usageGraphOptions.series.0.data', coresData);
            this.set('usageGraphOptions.series.1.data', usageData);
            if (this.usageGraph)
                this.usageGraph.setOption(this.usageGraphOptions);
            console.log('updated usage data');
        },

        computePastItems: function (timeParamsChangeRecord) {
            // console.log("loadingData", this.loadingData);
            var items = [];
            if (this.timeParams.window == "hour") {
                items.push({
                    value: 0,
                    text: "this hour"
                });
                items.push({
                    value: 1,
                    text: "last hour"
                });
                for (var i = 2; i < 11; i++) {
                    items.push({
                        value: i,
                        text: i + " hours ago"
                    });
                }
            } else if (this.timeParams.window == "day") {
                items.push({
                    value: 0,
                    text: "today"
                });
                items.push({
                    value: 1,
                    text: "yesterday"
                });
                for (var i = 2; i < 11; i++) {
                    items.push({
                        value: i,
                        text: i + " days ago"
                    });
                }
            } else if (this.timeParams.window == "week") {
                items = [{
                    value: '0',
                    text: 'this week'
                }, {
                    value: '1',
                    text: 'last week'
                }, {
                    value: '2',
                    text: 'two weeks ago'
                }, {
                    value: '3',
                    text: 'three weeks ago'
                }]
            } else if (this.timeParams.window == "month") {
                for (var i = 0; i < 12; i++) {
                    var t = '';
                    if (i == 0)
                        t = 'this month';
                    else if (i == 1)
                        t = 'last month';
                    else
                        t = i + ' months ago';

                    items.push({
                        value: i,
                        text: t
                    })
                }
            } else if (this.timeParams.window == "quarter") {
                items = [{
                    value: '0',
                    text: 'current quarter'
                }, {
                    value: '1',
                    text: 'previous quarter'
                }, {
                    value: '2',
                    text: '2 quarters ago'
                }, {
                    value: '3',
                    text: '3 quarters ago'
                }]
            }

            this.set('pastItems', items);

            // if window changed reset selected past
            if (timeParamsChangeRecord.path == 'timeParams.window') {
                this.set('timeParams.past', '0');
                this.async(function () {
                    this.$.past.selected = -1;
                    this.$.past.selected = 0;
                }, 100, this)
            }
        },

        computeFilterbyItems: function (filterby) {
            var items = [], 
                clouds = [], stacks = [], tokentags = [];
            if (this.token){
                if (this.clouds)
                    clouds = this.clouds.map(function(c){
                        return {name: c.title, id: c.id};
                    });
                if (this.stacks) {
                    stacks = this.stacks.map(function(c){
                        return {name: c.name, id: c.id};
                    });
                }
                if (this.tags) {
                    tokentags = this.tags.map(function(c){
                        return {name: c.name, id: c.name};
                    });
                }
            }
            if (this.filterby.type == 'stack')
                items = this.model.stacksArray || stacks;
            else if (this.filterby.type == 'cloud')
                items = this.model.cloudsArray || clouds;
            else if (this.filterby.type == 'tag'){
                var tags = [];
                if (!token) {
                    tags = this.model.machinesArray.filter(function(m){
                            return m.tags.length > 0
                        }).map(function(m){
                            for (var i=0; i < m.tags.length; i++){
                                var postfix = '';
                                if (m.tags[i].value != ''){
                                    postfix = '='+m.tags[i].value;
                                }
                                return {
                                    'name': m.tags[i].key+postfix,
                                    'id': m.tags[i].key+postfix,
                                    'val': m.tags[i].val
                                };
                            }
                        });
                    var names = tags.map(function(t){
                        return t.name;
                    })
                }
                items = tags.filter(function(t, ind){
                    return names.indexOf(t.name) == ind;
                });
            }
            else
                items = [];

            if (!items.length){
                this.set('filterbyDisable', true);
            }
            else {
                this.set('filterbyDisable', false);
            }

            this.set('filterbyItems',items);

            // if filterby changed reset selected item
            if (filterby.path == 'filterby.type'){
                this.set('filterby.name', '');
                this.async(function(){
                    this.$.filterbyName.selected = '';
                }, 100, this)
            }
            // if filterby id changed update name
            if (filterby.path == 'filterby.id'){
                this.set('filterby.name', this.computeName(filterby.value));
            }

        },

        combineParams: function(time, filter) {
            // console.log('p send ', filter);
            
            // dont update params so dont request, if user changes window, type, name or has not specified filter by id
            // also dont request for past = -1
            if (filter.path == 'filterby.type' || filter.path == 'filterby.name' || time.path == 'timeParams.window' || (filter.path == 'filterby.id' && filter.value == "") || time.value == "-1") {
                // console.log('dont send ', this.params);
            }
            else {
                var p = {
                    window: this.timeParams.window,
                    past: this.timeParams.past
                };

                if (this.filterby.type != '' && this.filterby.id != ''){
                    p[this.filterby.type] = this.filterby.id;
                }
                
                // console.log('p send ', p, this.params);
                this.set('params', p);
                this.$.costReportAjax.generateRequest();
                this.$.usageReportAjax.generateRequest();
            }
        },

        computeName: function(id){
                if (id){
                    if (this.filterby.type == 'tag') {
                        return id;
                    }
                    else if (this.filterby.type == 'cloud') {
                        if (!this.token)
                            return this.model.clouds[id].title;
                        else 
                            return this.clouds && this.clouds.find(function(c){
                                return c.id == id;
                            }).title;
                    }
                    else if (this.filterby.type == 'stack') {
                        if (!this.token)
                            return this.model.stacks[id].name;
                        else
                            return this.stacks && this.stacks.find(function(s){
                                return s.id == id;
                            }).name;
                    }
                }
                else {
                    return '';
                }
            },

        handleResponse: function (e) {
            console.log('handleResponse', e);
        },

        handleResponseClouds: function (e) {
            console.log('handleResponseClouds', e);
            this.set('clouds', e.detail.xhr.response);
        },

        handleResponseCostReport: function (e) {
            console.log('handleResponseCostReport', e);
            this.set('costReport', e.detail.xhr.response);
            this.$.usageReportAjax.generateRequest();
        },

        handleResponseUsageReport: function (e) {
            console.log('handleResponseUsageReport', e);
            this.set('usageReport', e.detail.xhr.response);
        },

        handleError: function (e) {
            console.log('handleError', e);
        }
    });
  </script>
</dom-module>