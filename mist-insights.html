<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<script src="../moment/moment.js"></script>
<!--
`mist-insights`


@demo demo/index.html
-->

<dom-module id="mist-insights">
    <template>
        <style>
             :host {
                display: block;
            }

            #graphRow[largescreen] {
                display: flex;
            }

            #graphRow[largescreen] .block+.block {
                padding-left: 48px;
            }
        </style>

        <iron-media-query query="(min-width: 1180px)" query-matches="{{largescreen}}"></iron-media-query>

        <paper-material id="filtering" class="margin-botttom">
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <div class="smaller">Time</div>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="window" class="dropdown-content" attr-for-selected="value" selected="{{timeParams.window}}">
                            <paper-item value="hour">hourly</paper-item>
                            <paper-item value="day">daily</paper-item>
                            <paper-item value="week">weekly</paper-item>
                            <paper-item value="month">monthly</paper-item>
                            <paper-item value="quarter">quarterly</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="past" class="dropdown-content" attr-for-selected="value" selected="{{timeParams.past}}">
                            <template is="dom-repeat" items="{{pastItems}}" as="past">
                                <paper-item value="[[past.value]]">[[past.text]]</paper-item>
                            </template>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
                <div class="flexchild">
                    <div class="smaller">Filter by</div>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="filterbyType" class="dropdown-content" attr-for-selected="value" selected="{{filterby.type}}">
                            <paper-item value="stack">Stack</paper-item>
                            <paper-item value="cloud">Cloud</paper-item>
                            <paper-item value="tag">Tag</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu id="filterbyNameDd" class="uppercase" no-label-float>
                        <paper-menu id="filterbyName" class="dropdown-content" attr-for-selected="value" selected="{{filterby.id}}">
                            <template is="dom-repeat" items="{{filterbyItems}}">
                                <paper-item value="[[item.id]]" data-name$="[[item.name]][[item.title]]">[[item.name]][[item.title]]</paper-item>
                            </template>
                            <paper-item disabled hidden$="{{!filterbyDisable}}">
                                <span hidden$="{{!filterby.type}}">no {{filterby.type}}s</span>
                                <span hidden$="{{filterby.type.length}}">Select type</span>
                            </paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-button class="inline baseline smaller" on-tap="clearFilter" disabled$="{{!filterby.id.length}}">clear</paper-button>
                </div>
            </div>
        </paper-material>

        <h2>[[clouds]]!</h2>


        <iron-ajax id="cloudsAjax"
            method="GET"
            url$="[[uri]]/api/v1/clouds"
            headers$='{"Authorization": "[[token]]"}'
            handle-as="json"
            loading={{loading}}
            on-response="handleResponse"
            on-error="handleError"></iron-ajax>

        <iron-ajax id="reportAjax"
            method="GET"
            url$="[[uri]]/api/v1/report"
            headers$='{"Authorization": "[[token]]"}'
            handle-as="json"
            loading="{{loadingData}}"
            on-response="handleResponse"
            on-error="handleError"
            params=[[params]]></iron-ajax>

        <iron-ajax id="loadReportAjax"
            method="GET"
            url="[[uri]]/api/v1/report?type=load"
            headers$='{"Authorization": "[[token]]"}'
            handle-as="json"
            loading="{{loadingDataLoad}}"
            on-response="handleResponseLoad"
            on-error="handleError"
            params=[[params]]></iron-ajax>

    </template>

    <script>
    Polymer({
        is: 'mist-insights',

        properties: {
            model: {
                type: Object,
                value: function () {
                    return {};
                }
            },
            token: {
                type: String,
                value: '',
            },
            uri: {
                type: String,
                value: 'https://mist.io'
            },
            largescreen: Boolean,
            params: {
                type: Object
            },
            timeParams: {
                type: Object,
                value: {
                    window: "day",
                    past: "0"
                }
            },
            filterby: {
                type: Object,
                value: {
                    type: '',
                    name: '',
                    id: ''
                }
            },
        },

        attached: function () {
            if (typeof echarts == 'undefined')
                this.importHref(this.resolveUrl('echarts-import.html'), this.initCharts, function(e) {
                    console.error('Failed to load echarts', e);
                }, true);
            else
                this.initCharts();

            if (!this.token)
                this.uri = '';
            this.$.cloudsAjax.generateRequest();
        },

        initCharts: function() {
            var colorPalette = ['#607D8B', '#d96557', '#3F51B5', '#009688', '#795548', '#8c76d1', '#795548','#0277BD', '#0099cc', '#424242', '#D48900', '#43A047', '#2F2F3E'];
            echarts.registerTheme('insights', {
                color: colorPalette,
                backgroundColor: 'transparent',
                graph: {
                    color: colorPalette
                }
            });
            /*this.costgraph = echarts.init(this.$.costgraph, 'insights');
            this.loadgraph = echarts.init(this.$.loadgraph, 'insights');
            this.drillcostgraph = echarts.init(this.$.drillcostgraph);
            this.machinesgraph = echarts.init(this.$.machinesgraph);
            this.updateChartWidth(e);*/
            console.log('initialized charts');
        },

        handleResponse: function (e) {
            console.log('handleResponse', e);
        },

        handleError: function (e) {
            console.log('handleError', e);
        }
    });
  </script>
</dom-module>